name: CI Pipeline

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

permissions:
    contents: read

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Install bun
              uses: oven-sh/setup-bun@v2
            - name: Install dependencies
              run: bun install
            - name: Run linter
              run: bun run lint

    test:
        name: Test
        runs-on: ubuntu-latest
        needs: [lint]
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Install bun
              uses: oven-sh/setup-bun@v2
            - name: Install dependencies
              run: bun install
            - name: Run tests
              run: bun test

    build-website:
        name: Build Website
        runs-on: ubuntu-latest
        needs: [test]
        defaults:
            run:
                working-directory: website
        steps:
            - uses: actions/checkout@v4
            - name: Install Bun
              uses: oven-sh/setup-bun@v1
            - name: Install dependencies
              run: bun install
            - name: Build website
              run: bun run build

    build-frontend:
        name: Build Frontend
        runs-on: ubuntu-latest
        needs: [test]
        defaults:
            run:
                working-directory: frontend
        steps:
            - uses: actions/checkout@v4
            - name: Install Bun
              uses: oven-sh/setup-bun@v1
            - name: Install dependencies
              run: bun install
            - name: Build frontend
              run: bun run build

    build-backend:
        name: Build Backend
        runs-on: ubuntu-latest
        needs: [test]
        defaults:
            run:
                working-directory: backend
        steps:
            - uses: actions/checkout@v4
            - name: Install Bun
              uses: oven-sh/setup-bun@v1
            - name: Install dependencies
              run: bun install
            - name: Generate Prisma client
              run: bunx prisma generate
            - name: Build backend
              run: bun run build
